[package]
name = "crdb"
version = "0.1.0"
edition = "2021"
license = "AGPL3"

[package.metadata.docs.rs]
all-features = true

[features]
client = [
    "async-stream",
    "paste",
    "sqlx/sqlite",
    "sqlx/uuid",
    "tokio-tungstenite",
    "tokio-util",
]
server = [
    "axum",
    "cron",
    "lockable",
    "rand",
    "sqlx/rust_decimal",
    "sqlx/json",
    "sqlx/postgres",
    "sqlx/uuid",
    "tokio-util",
]
_tests = [ # internal feature, for use by wasm tests in particular and thus all tests from there on
    "arbitrary",
    "arbitrary-json",
    "bolero",
    "console_error_panic_hook",
    "paste",
    "rand",
    "tracing-wasm",
]

[package.metadata.cargo-udeps.ignore]
normal = [
    "reord", # TODO(test): this should probably actually be used in all the builds
]
development = [
    "reord", # TODO(test): this should probably actually be used in all the builds
]

[dependencies]
anyhow = "1.0"
chrono = "0.4.31"
deepsize = "0.2.0"
educe = "0.5.9"
futures = "0.3.29"
icu_casemap = "1.4"
icu_normalizer = "1.4"
icu_properties = "1.4"
icu_segmenter = "1.4"
reord = "0.2.2"
rust_decimal = { version = "1.33", features = ["serde-arbitrary-precision"] }
rust-stemmers = "1.2"
serde = { version = "1.0", features = ["derive", "rc"] }
serde_json = { version = "1.0", features = ["arbitrary_precision"] }
sha3 = "0.10.8"
thiserror = "1.0"
tokio = { version = "1.35", features = ["macros", "rt", "sync"] }
tracing = "0.1.40"
ulid = { version = "1.1", features = ["serde"] }
writeable = "0.5.4"

# Optional dependencies
async-stream = { version = "0.3.5", optional = true }
axum = { version = "0.7.2", optional = true }
cron = { version = "0.12.0", optional = true }
lockable = { version = "0.0.8", optional = true }
paste = { version = "1.0", optional = true }
rand = { version = "0.8.5", optional = true }
tokio-util = { version = "0.7.10", optional = true }

# Optional dependencies, for tests
arbitrary = { version = "1.3", features = ["derive"], optional = true }
arbitrary-json = { version = "=0.1.1", optional = true } # very small crate, can we actually trust updates?
bolero = { version = "0.10.0", features = ["arbitrary"], optional = true }
console_error_panic_hook = { version = "0.1.7", optional = true }
tracing-wasm = { version = "0.2.1", optional = true }

# Dependencies specifically for wasm32
[target.'cfg(target_arch = "wasm32")'.dependencies]
getrandom = { version = "0.2.11", features = ["js"] }
gloo-net = "0.5.0"
indexed-db = "0.3.4"
js-sys = "0.3.67"
serde-wasm-bindgen = "0.6.3"
wasm-bindgen = "0.2.90"
wasm-bindgen-futures = "0.4.39"
wasm-timer = "0.2.5"
web-sys = { version = "0.3.66", features = ["DomException", "Event", "IdbDatabase", "IdbFactory", "IdbIndex", "IdbObjectStore", "IdbObjectStoreParameters", "IdbOpenDbRequest", "IdbTransaction", "IdbTransactionMode", "Navigator", "StorageManager", "Window"] }

# Dependencies specifically for native
[target.'cfg(not(target_arch = "wasm32"))'.dependencies]
sqlx = { version = "0.7.3", features = ["runtime-tokio"] }
uuid = "1.6"

# Optional dependencies specifically for native
tokio-tungstenite = { version = "0.21.0", optional = true }

[dev-dependencies]
num-bigint = { version = "0.4.4", features = ["arbitrary"] }
reord = { version = "0.2.2", features = ["test"] }
rust_decimal = { version = "1.33", features = ["rust-fuzz"] }
tempfile = "3.9"
tracing-subscriber = "0.3.18"
wasm-bindgen-test = "0.3.39"
web-sys = { version = "0.3.66", features = ["console"] }

[target.'cfg(not(target_arch = "wasm32"))'.dev-dependencies]
tokio = { version = "1.35", features = ["full"] }

[profile.fuzz]
inherits = "dev"
opt-level = 3
incremental = false
codegen-units = 1
